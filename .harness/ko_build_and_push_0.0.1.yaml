template:
  name: ko build and push
  type: Step
  spec:
    type: Run
    spec:
      connectorRef: <+input>
      image: kameshsampath/kube-dev-tools:0.1.5
      shell: Bash
      command: |-
        echo "$IMAGE_REGISTRY_PASSWORD" | ko login "$IMAGE_REGISTRY" -u  "$IMAGE_REGISTRY_USERNAME" --password-stdin
        image_digests=$(ko build --bare \
          --image-label="org.opencontainers.image.source=<+trigger.repoUrl>" \
          --tags=latest \
          --tags="$IMAGE_TAG" \
          --platform=linux/amd64 \
          --platform=linux/arm64)
      envVariables:
        IMAGE_TAG: <+input>
        KO_DOCKER_REPO: <+input>
        IMAGE_REGISTRY: <+input>
        IMAGE_REGISTRY_USERNAME: <+input>
        IMAGE_REGISTRY_PASSWORD: <+input>
      outputVariables:
        - name: image_digests
      imagePullPolicy: IfNotPresent
    description: Builds a go application using ko and pushes the image to repo set via $KO_DOCKER_REPO
  identifier: ko_build_and_push
  description: Builds a go application using ko and pushes the image to repo KO_DOCKER_REPO
  versionLabel: 0.0.1
